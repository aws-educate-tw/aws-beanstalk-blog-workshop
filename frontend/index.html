<!DOCTYPE html>
<html>
  <head>
    <title>My Blog</title>
    <meta charset="UTF-8" />

    <script>
      BASE_URL = "http://PutYourBaseUrlHere";
    </script>

    <!-- Google font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Titillium+Web:400,400i,600,600i,700,700i,900"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600,600i,700,700i,800,800i"
    />
    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    />
    <!-- icofont -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/ionic/1.3.2/css/ionic.css"
    />
    <!-- carousel -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.css"
    />

    <style>
      body {
        overflow-y: hidden;
      }

      button[disabled] {
        opacity: 0.65;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        -webkit-box-shadow: rgba(0, 0, 0, 0.3);
        box-shadow: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background: rgba(17, 16, 16, 0.13);
        -webkit-box-shadow: rgba(0, 0, 0, 0.9);
        box-shadow: rgba(0, 0, 0, 0.5);
      }

      .blog_section {
        max-height: 100vh;
        overflow-y: hidden;
        padding-bottom: 3rem;
      }

      .blog_item .blog_image img {
        width: 223.32px;
        height: 148.06px;
        object-fit: cover;
      }

      .blog_item .blog_details p {
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      form {
        max-width: 600px;
        width: 100%;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      label {
        display: block;
        margin-bottom: 8px;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin-bottom: 16px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      input[type="file"] {
        margin-bottom: 8px;
      }

      button {
        background-color: #007bff;
        color: #fff;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .modal {
        display: none; /* Hidden by default */
        z-index: 1050; /* Sit on top */
        overflow-y: hidden;
        border-radius: 8px;
        background-color: transparent;
      }

      .modal::-webkit-scrollbar {
        display: none;
      }

      .modal {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #modal-image {
        width: 300px;
      }

      .modal-content {
        overflow-y: auto;
      }

      #articleModal.modal {
        display: none; /* Hidden by default */
        z-index: 1050; /* Sit on top */
        height: 100%;
        border-radius: 8px;
        background-color: transparent;
      }

      #editArticleModal.modal {
        display: none; /* Hidden by default */
        z-index: 1050; /* Sit on top */
        height: 100%;
        border-radius: 8px;
        background-color: transparent;
      }

      #modal-poster {
        color: gray;
        font-style: italic;
      }
    </style>
  </head>

  <body>
    <section class="blog_section">
      <div class="px-4 py-4 my-5 text-center">
        <img
          class="d-block mx-auto mb-4"
          src="blogging.png"
          alt=""
          width="72"
          height="57"
        />
        <h1 class="display-5 fw-bold text-body-emphasis">My Blog</h1>
        <!-- <div class="col-lg-6 mx-auto">
              <p class="lead mb-4">Quickly design and customize responsive mobile-first sites with Bootstrap, the world’s most popular front-end open source toolkit, featuring Sass variables and mixins, responsive grid system, extensive prebuilt components, and powerful JavaScript plugins.</p>
            </div> -->
      </div>

      <div class="container">
        <div class="blog_content">
          <div class="owl-carousel owl-theme"></div>
        </div>
      </div>

      <div
        class="container"
        style="margin-top: 60px; display: flex; justify-content: center"
      >
        <!-- <div class="card"> -->
        <form id="BlogForm">
          <label for="poster">姓名:</label>
          <input
            id="poster"
            class="form-control"
            name="poster"
            rows="1"
            required
          />

          <label for="title">標題:</label>
          <input
            id="title"
            class="form-control"
            name="title"
            rows="1"
            required
          />

          <label for="content">文章:</label>
          <textarea
            id="content"
            class="form-control"
            name="content"
            rows="4"
            required
          ></textarea>

          <label for="image">上傳圖片:</label>
          <div class="input-group">
            <div class="custom-file">
              <input
                type="file"
                class="custom-file-input"
                id="image"
                name="image"
                accept="image/*"
                required
              />
              <label class="custom-file-label" for="image">選擇文件</label>
            </div>
          </div>

          <hr />
          <button type="submit">提交</button>
        </form>
        <!-- </div> -->
      </div>
    </section>

    <!-- Detail Modal -->
    <div
      class="modal fade"
      id="articleModal"
      role="dialog"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title" id="modal-title"></h3>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="modal-poster"></p>
            <img id="modal-image" src="" alt="Article Image" />
            <p id="modal-content"></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editArticleModal" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Article</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="editArticleForm">
              <input type="hidden" id="editArticleId" />
              <div>
                <label for="editPoster">Poster:</label>
                <input
                  type="text"
                  class="form-control"
                  id="editPoster"
                  name="poster"
                />
              </div>
              <div>
                <label for="editTitle">Title:</label>
                <input
                  type="text"
                  class="form-control"
                  id="editTitle"
                  name="title"
                />
              </div>
              <div>
                <label for="editContent">Content:</label>
                <textarea
                  class="form-control"
                  id="editContent"
                  name="content"
                  rows="4"
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">Update</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="deleteConfirmModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body">
            <b>確定刪除文章 <span id="deleteArticleTitle"></span>?</b>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary btn-sm"
              data-dismiss="modal"
            >
              取消
            </button>
            <button
              type="button"
              class="btn btn-danger btn-sm"
              id="confirmDelete"
            >
              確認
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <!-- bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.min.js"></script>
    <!-- carousel -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.js"
    ></script>

    <!-- credit: https://bootsnipp.com/snippets/NAjW6 -->

    <script src="index.js"></script>
    <link rel="stylesheet" href="styles.css" />

    <script>
      $(document).ready(function () {
        // Fetch and display dynamic blog content
        $.ajax({
          url: BASE_URL + "/api/articles",
          type: "GET",
          dataType: "json",
          success: function (data) {
            displayBlogContent(data);
          },
          error: function (xhr, status, error) {
            var err = eval("(" + xhr.responseText + ")");
            console.log(err.Message);
          },
        });
      });

      function getArticleDetails(articleId) {
        fetch(BASE_URL + "/api/articles/" + articleId)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("modal-title").innerText = data.title;
            document.getElementById("modal-poster").innerText =
              data.poster + " / " + data.updateAt;
            document.getElementById("modal-image").src = data.imageUrl;
            document.getElementById("modal-content").innerText = data.content;
            $("#articleModal").modal("show");
          });
      }

      function editArticle(articleId) {
        fetch(BASE_URL + "/api/articles/" + articleId)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("editArticleId").value = articleId;
            document.getElementById("editPoster").value = data.poster;
            document.getElementById("editTitle").value = data.title;
            document.getElementById("editContent").value = data.content;
            $("#editArticleModal").modal("show");
          });

        $("#editArticleForm")
          .off("submit")
          .on("submit", function (e) {
            e.preventDefault();
            var submitButton = $(this).find('button[type="submit"]');
            submitButton.prop("disabled", true).css("opacity", "0.65");

            var updatedData = {
              poster: document.getElementById("editPoster").value,
              title: document.getElementById("editTitle").value,
              content: document.getElementById("editContent").value,
            };

            fetch(BASE_URL + "/api/articles/" + articleId, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(updatedData),
            })
              .then((response) => {
                $("#editArticleModal").modal("hide");
                location.reload();
              })
              .catch((error) => {
                console.log(error);
                submitButton.prop("disabled", false).css("opacity", "1");
              });
          });
      }

      function deleteArticle(articleId, articleTitle) {
        $("#deleteArticleTitle").text(articleTitle);
        $("#deleteConfirmModal").modal("show");

        $("#confirmDelete")
          .off("click")
          .on("click", function () {
            var deleteButton = $(this);
            deleteButton.prop("disabled", true).css("opacity", "0.65");

            fetch(BASE_URL + "/api/articles/" + articleId, {
              method: "DELETE",
            })
              .then((response) => {
                $("#deleteConfirmModal").modal("hide");
                location.reload();
              })
              .catch((error) => {
                console.log(error);
                deleteButton.prop("disabled", false).css("opacity", "1");
              });
          });
      }

      document
        .getElementById("editArticleForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const articleId = document.getElementById("editArticleId").value;
          const updatedData = {
            poster: document.getElementById("editPoster").value,
            title: document.getElementById("editTitle").value,
            content: document.getElementById("editContent").value,
          };

          fetch(BASE_URL + "/api/articles/" + articleId, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updatedData),
          })
            .then((response) => {
              // Handle response
              $("#editArticleModal").modal("hide");
            })
            .catch((error) => {
              // Handle error
            });
        });

      function displayBlogContent(data) {
        var blogContainer = [];

        data.forEach(function (item) {
          var blogItem = $(
            `<div class="blog_item" data-article-id="${item.articleId}">`
          );
          blogItem.html(`
            <div class="blog_image" style="position: relative;">
                <img class="img-fluid" src="${item.imageUrl}" alt="images not found">
                <div class="dropdown" style="position: absolute; top: 10px; right: 10px;">
                <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton${item.articleId}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="icon ion-md-more"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton${item.articleId}">
                    <a class="dropdown-item" href="#" onclick="editArticle('${item.articleId}')">Edit</a>
                    <a class="dropdown-item" href="#" onclick="deleteArticle('${item.articleId}')">Delete</a>
                </div>
                </div>
            </div>
            <div class="blog_details">
            <div class="blog_title">
                <h5><a href="#">${item.title}</a></h5>
            </div>
            <ul>
                <li><i class="icon ion-md-person"></i>${item.poster}</li>
                <li><i class="icon ion-md-calendar"></i>${item.createAt}</li>
            </ul>
            <p>${item.content}</p>
            </div>
        `);

          blogItem.find(".blog_title h5 a").click(function (e) {
            e.preventDefault();
            var articleId = $(this).closest(".blog_item").data("article-id");
            getArticleDetails(articleId);
          });

          blogContainer.push(blogItem);
        });

        var enableAutoplay = data.length >= 3;
        var page_item = 3;
        var page_center = false;
        if (data.length == 1) {
          page_item = 3;
          page_center = true;
        } else if (data.length == 2) {
          page_item = 2;
          page_center = false;
        }

        $(".owl-carousel")
          .owlCarousel("destroy")
          .owlCarousel({
            loop: false,
            rewind: true,
            margin: 10,
            center: page_center, // Center the single item
            autoplay: enableAutoplay, // Enable autoplay
            autoplayTimeout: 3000, // Set autoplay interval in milliseconds (adjust as needed)
            responsive: {
              0: {
                items: page_item,
                nav: false,
              },
            },
          });

        blogContainer.forEach(function (item) {
          $(".owl-carousel").trigger("add.owl.carousel", item);
        });

        $(".owl-carousel").trigger("refresh.owl.carousel");
      }

      $("#BlogForm").submit(function (event) {
        event.preventDefault();
        var submitButton = $(this).find('button[type="submit"]');
        submitButton.prop("disabled", true);

        var formData = new FormData(this);
        var jsonData = {
          poster: $("#poster").val(),
          title: $("#title").val(),
          content: $("#content").val(),
        };

        var jsonFormData = new FormData();
        jsonFormData.append("data", JSON.stringify(jsonData));
        jsonFormData.append("image", formData.get("image"));

        $.ajax({
          url: BASE_URL + "/api/articles",
          type: "POST",
          data: jsonFormData,
          processData: false,
          contentType: false,
          success: function (response) {
            console.log("Form submitted successfully:", response);
            location.reload();
          },
          error: function (xhr, status, error) {
            alert("Error occurred:", xhr.status, error);
            submitButton.prop("disabled", false);
          },
        });
      });

      document.querySelectorAll(".article-card").forEach((card) => {
        card.addEventListener("click", () => {
          const articleId = card.getAttribute("data-article-id");
          getArticleDetails(articleId);
        });
      });

      $("#image").on("change", function () {
        var fileName = $(this).val().split("\\").pop();
        $(this)
          .siblings(".custom-file-label")
          .addClass("selected")
          .html(fileName);
      });
    </script>
  </body>
</html>
